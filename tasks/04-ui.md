# Task 04: UI (Frontend Vue)

## Objetivo
Implementar la aplicación Vue completa: componentes, vistas, routing, stores y servicios.

---

## 1. Estructura base

```
resources/js/
├── App.vue
├── app.ts (entry point)
├── router/
│   └── index.ts
├── stores/
│   ├── auth.ts
│   └── family.ts
├── services/
│   ├── api.ts
│   ├── auth.service.ts
│   ├── family.service.ts
│   ├── shopping.service.ts
│   ├── calendar.service.ts
│   ├── task.service.ts
│   └── birthday.service.ts
├── composables/
│   └── usePwaInstall.ts
├── types/
│   ├── user.ts
│   ├── family.ts
│   ├── shopping.ts
│   ├── calendar.ts
│   ├── task.ts
│   └── birthday.ts
├── components/
│   ├── layout/
│   ├── shopping/
│   ├── calendar/
│   ├── tasks/
│   └── birthdays/
└── views/
    ├── auth/
    ├── family/
    ├── Dashboard.vue
    ├── ShoppingList.vue
    ├── Calendar.vue
    ├── Tasks.vue
    └── Birthdays.vue
```

---

## 2. app.ts (entry point)

**resources/js/app.ts:**

```typescript
import { createApp } from 'vue';
import { createPinia } from 'pinia';
import App from './App.vue';
import router from './router';
import './bootstrap';

const app = createApp(App);

app.use(createPinia());
app.use(router);
app.mount('#app');
```

**resources/js/bootstrap.ts:**

```typescript
import axios from 'axios';

window.axios = axios;
window.axios.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest';
window.axios.defaults.withCredentials = true;
```

---

## 3. API Service

**resources/js/services/api.ts:**

```typescript
import axios, { AxiosInstance } from 'axios';

const api: AxiosInstance = axios.create({
    baseURL: import.meta.env.VITE_API_URL || '/api',
    withCredentials: true,
    headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
    },
});

// Interceptor para añadir token
api.interceptors.request.use((config) => {
    const token = localStorage.getItem('auth_token');
    if (token) {
        config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
});

// Interceptor para manejar errores
api.interceptors.response.use(
    (response) => response,
    (error) => {
        if (error.response?.status === 401) {
            localStorage.removeItem('auth_token');
            window.location.href = '/login';
        }
        return Promise.reject(error);
    }
);

export default api;
```

---

## 4. Types

**resources/js/types/user.ts:**

```typescript
export interface User {
    _id: string;
    name: string;
    email: string;
    email_verified_at: string | null;
    family_id: string | null;
    created_at: string;
    updated_at: string;
}
```

**resources/js/types/family.ts:**

```typescript
import type { User } from './user';

export interface Family {
    _id: string;
    name: string;
    code: string;
    created_by: string;
    members?: User[];
    created_at: string;
    updated_at: string;
}
```

Crear el resto de types según SPEC.md

---

## 5. Stores (Pinia)

**resources/js/stores/auth.ts:**

```typescript
import { defineStore } from 'pinia';
import { ref, computed } from 'vue';
import type { User } from '@/types/user';
import authService from '@/services/auth.service';

export const useAuthStore = defineStore('auth', () => {
    const user = ref<User | null>(null);
    const token = ref<string | null>(localStorage.getItem('auth_token'));

    const isAuthenticated = computed(() => !!token.value && !!user.value);
    const hasFamily = computed(() => !!user.value?.family_id);
    const isEmailVerified = computed(() => !!user.value?.email_verified_at);

    async function login(email: string, password: string) {
        const response = await authService.login(email, password);
        token.value = response.token;
        user.value = response.user;
        localStorage.setItem('auth_token', response.token);
    }

    async function register(name: string, email: string, password: string, password_confirmation: string) {
        await authService.register(name, email, password, password_confirmation);
    }

    async function logout() {
        await authService.logout();
        token.value = null;
        user.value = null;
        localStorage.removeItem('auth_token');
    }

    async function fetchUser() {
        if (!token.value) return;
        user.value = await authService.getUser();
    }

    return {
        user,
        token,
        isAuthenticated,
        hasFamily,
        isEmailVerified,
        login,
        register,
        logout,
        fetchUser,
    };
});
```

**resources/js/stores/family.ts:**

```typescript
import { defineStore } from 'pinia';
import { ref } from 'vue';
import type { Family } from '@/types/family';
import familyService from '@/services/family.service';
import { useAuthStore } from './auth';

export const useFamilyStore = defineStore('family', () => {
    const family = ref<Family | null>(null);

    async function createFamily(name: string) {
        const response = await familyService.createFamily(name);
        family.value = response.family;
        const authStore = useAuthStore();
        await authStore.fetchUser();
        return response;
    }

    async function joinFamily(code: string) {
        const response = await familyService.joinFamily(code);
        family.value = response.family;
        const authStore = useAuthStore();
        await authStore.fetchUser();
        return response;
    }

    async function fetchFamily() {
        family.value = await familyService.getCurrentFamily();
    }

    async function leaveFamily() {
        await familyService.leaveFamily();
        family.value = null;
        const authStore = useAuthStore();
        await authStore.fetchUser();
    }

    return {
        family,
        createFamily,
        joinFamily,
        fetchFamily,
        leaveFamily,
    };
});
```

---

## 6. PWA Composable

**resources/js/composables/usePwaInstall.ts:**

```typescript
import { ref, computed } from 'vue'

const DISMISS_KEY = 'pwa-install-dismissed'

const deferredPrompt = ref<any>(null)
const dismissed = ref(localStorage.getItem(DISMISS_KEY) === '1')

function isStandalone(): boolean {
  if (window.matchMedia('(display-mode: standalone)').matches) return true
  if ('standalone' in navigator && (navigator as any).standalone) return true
  return false
}

const isAndroid = /Android/i.test(navigator.userAgent)
const isIos = /iPad|iPhone|iPod/.test(navigator.userAgent)

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault()
  deferredPrompt.value = e
})

window.addEventListener('appinstalled', () => {
  deferredPrompt.value = null
  dismissed.value = true
  localStorage.setItem(DISMISS_KEY, '1')
})

export function usePwaInstall() {
  const standalone = isStandalone()

  const showAndroidBanner = computed(() =>
    isAndroid && !!deferredPrompt.value && !dismissed.value && !standalone,
  )

  const showIosBanner = computed(() =>
    isIos && !standalone && !dismissed.value,
  )

  const install = async () => {
    if (!deferredPrompt.value) return
    deferredPrompt.value.prompt()
    const { outcome } = await deferredPrompt.value.userChoice
    if (outcome === 'accepted') {
      deferredPrompt.value = null
    }
    dismissed.value = true
    localStorage.setItem(DISMISS_KEY, '1')
  }

  const dismiss = () => {
    dismissed.value = true
    localStorage.setItem(DISMISS_KEY, '1')
  }

  return { showAndroidBanner, showIosBanner, install, dismiss }
}
```

---

## 7. Services

**resources/js/services/auth.service.ts:**

```typescript
import api from './api';
import type { User } from '@/types/user';

export default {
    async register(name: string, email: string, password: string, password_confirmation: string) {
        const { data } = await api.post('/register', { name, email, password, password_confirmation });
        return data;
    },

    async login(email: string, password: string) {
        await api.get('/sanctum/csrf-cookie');
        const { data } = await api.post('/login', { email, password });
        return data;
    },

    async logout() {
        await api.post('/logout');
    },

    async getUser(): Promise<User> {
        const { data } = await api.get('/user');
        return data;
    },

    async sendVerificationEmail() {
        await api.post('/email/verification-notification');
    },

    async forgotPassword(email: string) {
        const { data } = await api.post('/forgot-password', { email });
        return data;
    },

    async resetPassword(token: string, email: string, password: string, password_confirmation: string) {
        const { data } = await api.post('/reset-password', { token, email, password, password_confirmation });
        return data;
    },
};
```

Implementar el resto de servicios (family, shopping, calendar, task, birthday) siguiendo el mismo patrón.

---

## 8. Router

**resources/js/router/index.ts:**

```typescript
import { createRouter, createWebHistory, RouteRecordRaw } from 'vue-router';
import { useAuthStore } from '@/stores/auth';

const routes: RouteRecordRaw[] = [
    // Auth routes (guest only)
    {
        path: '/login',
        name: 'login',
        component: () => import('@/views/auth/Login.vue'),
        meta: { guest: true },
    },
    {
        path: '/register',
        name: 'register',
        component: () => import('@/views/auth/Register.vue'),
        meta: { guest: true },
    },
    {
        path: '/verify-email',
        name: 'verify-email',
        component: () => import('@/views/auth/VerifyEmail.vue'),
    },
    {
        path: '/forgot-password',
        name: 'forgot-password',
        component: () => import('@/views/auth/ForgotPassword.vue'),
        meta: { guest: true },
    },
    {
        path: '/reset-password/:token',
        name: 'reset-password',
        component: () => import('@/views/auth/ResetPassword.vue'),
        meta: { guest: true },
    },

    // Family setup
    {
        path: '/family/setup',
        name: 'family-setup',
        component: () => import('@/views/family/CreateOrJoin.vue'),
        meta: { requiresAuth: true, requiresNoFamily: true },
    },

    // Protected routes
    {
        path: '/',
        component: () => import('@/components/layout/AppLayout.vue'),
        meta: { requiresAuth: true, requiresFamily: true },
        children: [
            {
                path: '',
                name: 'dashboard',
                component: () => import('@/views/Dashboard.vue'),
            },
            {
                path: 'shopping',
                name: 'shopping',
                component: () => import('@/views/ShoppingList.vue'),
            },
            {
                path: 'calendar',
                name: 'calendar',
                component: () => import('@/views/Calendar.vue'),
            },
            {
                path: 'tasks',
                name: 'tasks',
                component: () => import('@/views/Tasks.vue'),
            },
            {
                path: 'birthdays',
                name: 'birthdays',
                component: () => import('@/views/Birthdays.vue'),
            },
            {
                path: 'family/settings',
                name: 'family-settings',
                component: () => import('@/views/family/Settings.vue'),
            },
        ],
    },
];

const router = createRouter({
    history: createWebHistory(),
    routes,
});

// Navigation guards
router.beforeEach(async (to, from, next) => {
    const authStore = useAuthStore();

    if (!authStore.user && authStore.token) {
        await authStore.fetchUser();
    }

    // Guest routes
    if (to.meta.guest && authStore.isAuthenticated) {
        return next({ name: 'dashboard' });
    }

    // Auth required
    if (to.meta.requiresAuth && !authStore.isAuthenticated) {
        return next({ name: 'login' });
    }

    // Email verification
    if (to.meta.requiresAuth && !authStore.isEmailVerified && to.name !== 'verify-email') {
        return next({ name: 'verify-email' });
    }

    // Family required
    if (to.meta.requiresFamily && !authStore.hasFamily) {
        return next({ name: 'family-setup' });
    }

    // No family required (setup page)
    if (to.meta.requiresNoFamily && authStore.hasFamily) {
        return next({ name: 'dashboard' });
    }

    next();
});

export default router;
```

---

## 9. Layout Components

**resources/js/components/layout/AppLayout.vue:**

```vue
<template>
  <div class="min-h-screen bg-gray-50">
    <!-- Android install banner -->
    <div
      v-if="showAndroidBanner"
      class="bg-[#2196F3] text-white px-4 py-2 flex items-center justify-between text-sm"
    >
      <span>Instala la app en tu dispositivo para acceder más rápido</span>
      <div class="flex items-center gap-2 ml-3 flex-shrink-0">
        <button
          class="px-3 py-1 bg-white text-[#2196F3] rounded font-medium text-xs hover:bg-[#E3F2FD] transition-colors"
          @click="install()"
        >
          Instalar
        </button>
        <button
          class="text-white/70 hover:text-white text-2xl leading-none p-2 -mr-2"
          @click.stop.prevent="dismiss()"
        >&times;</button>
      </div>
    </div>

    <!-- iOS install instructions -->
    <div
      v-if="showIosBanner"
      class="bg-[#2196F3] text-white px-4 py-2.5 flex items-center justify-between text-sm gap-3"
    >
      <span>
        Para instalar: pulsa
        <svg class="inline w-4 h-4 -mt-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M16 5l-1.42 1.42-1.59-1.59V16h-1.98V4.83L9.42 6.42 8 5l4-4 4 4zm4 5v11c0 1.1-.9 2-2 2H6c-1.11 0-2-.9-2-2V10c0-1.11.89-2 2-2h3v2H6v11h12V10h-3V8h3c1.1 0 2 .89 2 2z"/></svg>
        y luego <strong>Añadir a pantalla de inicio</strong>
      </span>
      <button
        class="text-white/70 hover:text-white text-lg leading-none flex-shrink-0"
        @click.stop.prevent="dismiss()"
      >&times;</button>
    </div>

    <!-- Mobile navbar -->
    <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-50">
      <div class="flex justify-around items-center h-16">
        <router-link
          v-for="item in navItems"
          :key="item.name"
          :to="{ name: item.route }"
          class="flex flex-col items-center justify-center flex-1 h-full text-gray-600 hover:text-primary"
          active-class="text-primary"
        >
          <component :is="item.icon" class="w-6 h-6" />
          <span class="text-xs mt-1">{{ item.label }}</span>
        </router-link>
      </div>
    </nav>

    <!-- Desktop sidebar -->
    <aside class="hidden md:block fixed left-0 top-0 bottom-0 w-64 bg-white border-r border-gray-200 z-40">
      <div class="p-6">
        <h1 class="text-2xl font-bold text-primary">Family Hub</h1>
      </div>
      <nav class="px-3">
        <router-link
          v-for="item in navItems"
          :key="item.name"
          :to="{ name: item.route }"
          class="flex items-center px-4 py-3 mb-1 rounded-lg text-gray-700 hover:bg-gray-100"
          active-class="bg-primary text-white hover:bg-primary"
        >
          <component :is="item.icon" class="w-5 h-5 mr-3" />
          {{ item.label }}
        </router-link>
      </nav>
    </aside>

    <!-- Main content -->
    <main class="md:ml-64 pb-20 md:pb-0">
      <header class="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center">
        <h2 class="text-xl font-semibold text-gray-800">{{ currentPageTitle }}</h2>
        <button @click="handleLogout" class="text-gray-600 hover:text-gray-800">
          Cerrar sesión
        </button>
      </header>
      <div class="p-6">
        <router-view />
      </div>
    </main>
  </div>
</template>

<script setup lang="ts">
import { computed } from 'vue';
import { useRouter, useRoute } from 'vue-router';
import { useAuthStore } from '@/stores/auth';
import { usePwaInstall } from '@/composables/usePwaInstall';
// Import icons (usar heroicons o similar)

const router = useRouter();
const route = useRoute();
const authStore = useAuthStore();
const { showAndroidBanner, showIosBanner, install, dismiss } = usePwaInstall();

const navItems = [
  { name: 'dashboard', label: 'Dashboard', route: 'dashboard', icon: 'HomeIcon' },
  { name: 'shopping', label: 'Compra', route: 'shopping', icon: 'ShoppingCartIcon' },
  { name: 'calendar', label: 'Calendario', route: 'calendar', icon: 'CalendarIcon' },
  { name: 'tasks', label: 'Tareas', route: 'tasks', icon: 'ClipboardListIcon' },
  { name: 'birthdays', label: 'Cumpleaños', route: 'birthdays', icon: 'CakeIcon' },
];

const currentPageTitle = computed(() => {
  const item = navItems.find((i) => i.route === route.name);
  return item?.label || 'Family Hub';
});

async function handleLogout() {
  await authStore.logout();
  router.push({ name: 'login' });
}
</script>
```

---

## 10. Views (implementar según SPEC.md)

Cada vista debe:
- Usar Composition API
- Fetch datos del service correspondiente
- Implementar CRUD según funcionalidad
- Responsive (mobile-first con Tailwind)

**Ejemplo: resources/js/views/Dashboard.vue**

```vue
<template>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Widget de compra -->
    <div class="bg-white rounded-lg shadow p-6">
      <h3 class="text-lg font-semibold mb-4">Lista de compra</h3>
      <ul class="space-y-2">
        <li v-for="item in dashboard.shopping" :key="item._id" class="flex items-center">
          <span>{{ item.item_name }}</span>
        </li>
      </ul>
      <router-link :to="{ name: 'shopping' }" class="text-primary mt-4 inline-block">
        Ver todo →
      </router-link>
    </div>

    <!-- Widget de eventos -->
    <!-- Similar estructura -->

    <!-- Widget de tareas -->
    <!-- Similar estructura -->

    <!-- Widget de cumpleaños -->
    <!-- Similar estructura -->
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue';
import api from '@/services/api';

const dashboard = ref({
  shopping: [],
  events: [],
  tasks: [],
  birthdays: [],
});

onMounted(async () => {
  const { data } = await api.get('/dashboard');
  dashboard.value = data;
});
</script>
```

---

## 11. Components específicos

Implementar componentes reutilizables:
- `ShoppingCard.vue` - Card de item de compra
- `CalendarMonth.vue` - Vista mensual calendario
- `CalendarYear.vue` - Vista anual calendario
- `TaskItem.vue` - Item de tarea con checkbox
- `BirthdayCard.vue` - Card de cumpleaños
- Etc.

---

## Checklist

- [ ] Router configurado con guards
- [ ] Stores (auth, family) funcionales
- [ ] Todos los services creados
- [ ] PWA composable (usePwaInstall) creado
- [ ] Layout responsive (sidebar + bottom nav)
- [ ] PWA banners (Android e iOS) implementados en AppLayout
- [ ] 5 vistas principales implementadas
- [ ] Auth flow completo (register, login, verify, reset)
- [ ] Family setup (create/join)
- [ ] Componentes reutilizables
- [ ] Estilos con Tailwind
- [ ] Testing navegación
- [ ] PWA manifest generado (vite build)
- [ ] Service worker funcional

---

**Próxima tarea:** `05-integration.md` (Conectar todo + testing)
